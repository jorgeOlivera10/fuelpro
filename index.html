<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Fuel Tracker</title>
  <meta name="theme-color" content="#0d111a">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    :root{--bg:#0c1117;--card:#0f1623;--line:#1d2838;--text:#e6edf3;--muted:#8aa0b7;--accent:#7c9fff;--ok:#2ecc71;--warn:#f1c40f;--err:#ff5d5d}
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:linear-gradient(180deg,#0b0f15,#0f1623 40%,#0b0f15);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    header{position:sticky;top:0;backdrop-filter:blur(8px);background:rgba(12,17,23,.65);border-bottom:1px solid var(--line);padding-top:env(safe-area-inset-top)}
    .wrap{max-width:980px;margin:0 auto;padding:12px 14px}
    h1{font-size:1.1rem;margin:0;letter-spacing:.2px}
    main{padding:16px 14px}
    .grid{display:grid;gap:14px}
    @media(min-width:900px){.grid{grid-template-columns:1.1fr .9fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 12px 32px rgba(0,0,0,.25)}
    .card .content{padding:14px}
    label{font-size:.85rem;color:var(--muted)}
    input,select,textarea{width:100%;padding:14px;border-radius:14px;background:#0b1320;border:1px solid #172338;color:var(--text);font-size:16px}
    textarea{min-height:76px;resize:vertical}
    .row{display:grid;gap:10px;margin-bottom:12px}
    @media(min-width:640px){.row-2{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:900px){.row-3{grid-template-columns:repeat(3,1fr)}}
    button{appearance:none;border:1px solid #2a3650;background:#1a2340;color:#dbe6ff;padding:14px;border-radius:14px;cursor:pointer}
    .primary{background:linear-gradient(135deg,#3957ff,#6aa0ff);border-color:transparent;color:#fff}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid #2a3650;background:#0b0f1a;border-radius:999px;padding:8px 12px;color:#cfd9ff;font-size:.85rem}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid var(--line);text-align:left;font-size:.92rem}
    th{color:#9fb0d1}
    footer{padding:24px 14px;color:var(--muted);text-align:center;padding-bottom:calc(24px + env(safe-area-inset-bottom))}
  </style>
</head>
<body>
  <header><div class="wrap"><h1>⛽ Fuel Tracker</h1></div></header>

  <main class="wrap grid">
    <section class="card">
      <div class="content">
        <h2 style="margin:0 0 8px">Nuevo registro</h2>
        <form id="form">
          <div class="row row-3">
            <div>
              <label for="fecha">Fecha</label>
              <input id="fecha" name="fecha" type="date" required>
            </div>
            <div>
              <label for="vehiculo">Vehículo</label>
              <select id="vehiculo" name="vehiculo">
                <option>Peugeot 206</option>
              </select>
            </div>
            <div>
              <label for="fuel">Combustible</label>
              <select id="fuel" name="fuel">
                <option>Diésel</option>
                <option>Gasolina</option>
              </select>
            </div>
          </div>

          <div class="row row-3">
            <div>
              <label for="euros">Euros (€)</label>
              <input id="euros" name="euros" type="number" inputmode="decimal" step="0.01" min="0" required>
            </div>
            <div>
              <label for="precio_litro">Precio/L (€/L)</label>
              <input id="precio_litro" name="precio_litro" type="number" inputmode="decimal" step="0.001" min="0" required>
            </div>
            <div>
              <label for="km">Odómetro (km)</label>
              <input id="km" name="km" type="number" inputmode="numeric" step="1" min="0" required>
            </div>
          </div>

          <div class="row row-2">
            <div>
              <label for="estacion">Estación</label>
              <input id="estacion" name="estacion" placeholder="Nombre o cadena" />
            </div>
            <div>
              <label for="pago">Pago</label>
              <select id="pago" name="pago">
                <option>Tarjeta</option>
                <option>Efectivo</option>
                <option>App</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="notas">Notas</label>
              <textarea id="notas" name="notas" placeholder="Ticket, autopista, ciudad, etc."></textarea>
            </div>
          </div>

          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <button type="submit" class="primary">Guardar</button>
            <button type="button" id="btn-clear">Limpiar</button>
            <span class="pill" id="status-pill">Sincronizado</span>
          </div>
        </form>
        <p class="muted" style="color:#8aa0b7;margin:.6rem 0 0">Consejo: registra siempre con el km del odómetro.</p>
      </div>
    </section>

    <section class="card">
      <div class="content">
        <h2 style="margin:0 0 8px">Resumen</h2>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:8px">
          <div class="pill">Consumo medio <b id="s-consumo">–</b> L/100km</div>
          <div class="pill">Coste medio <b id="s-coste">–</b> €/km</div>
          <div class="pill">CO₂ total <b id="s-co2">–</b> kg</div>
        </div>
        <h3 style="margin:.6rem 0;color:#cdd7f1;font-size:1rem">Últimos repostajes</h3>
        <table id="tabla">
          <thead><tr><th>Fecha</th><th>€</th><th>€/L</th><th>Km</th><th>Litros</th><th>L/100km</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer>iPhone listo: añade a pantalla de inicio desde Safari. Funciona offline y sincroniza con Google Sheets.</footer>

<script>
// ======= CONFIG =======
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbwnRGDahVQ_APm2qstM5-L4WXmJXnYQVPmSsjQAnjXuTmWZkEdhoGGpWcEjqCYix8mZFg/exec"; // actualiza con tu /exec
const GAS_API_KEY  = ""; // si pusiste API_KEY en Code.gs, pon la misma aquí
// ======= FIN CONFIG ===

const LS_ENTRIES='fuelEntries_v2', LS_QUEUE='fuelQueue_v2', CO2_PER_L=2.68;

function readLS(k,f){ try{ return JSON.parse(localStorage.getItem(k)||JSON.stringify(f)) }catch{ return f } }
function writeLS(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function fmt(n,d=2){ return (n==null||!isFinite(n))?'–': Number(n).toFixed(d) }
function uuid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36) }
function setStatus(t,k){ const el=document.getElementById('status-pill'); el.textContent=t; el.className='pill '+(k||''); }

function litersFrom(euros, price){ return price>0? euros/price : null }

function enrichRows(entries){
  // Ordenar por km y fecha para calcular consumos
  entries = [...entries].sort((a,b)=>(a.km-b.km)||String(a.fecha).localeCompare(String(b.fecha)));
  let rows=[];
  for(let i=0;i<entries.length;i++){
    const cur=entries[i], prev=entries[i-1];
    const litros = litersFrom(cur.euros, cur.precio_litro);
    const km_rec = prev ? (cur.km - prev.km) : 0;
    const l100 = (km_rec>0 && litros!=null) ? (litros/km_rec)*100 : null;
    const eur_km = km_rec>0 ? (cur.euros/km_rec) : null;
    const co2 = litros? litros*CO2_PER_L : 0;
    rows.push({...cur, litros, km_rec, l100, eur_km, co2});
  }
  const valid = rows.filter(r=> r.l100!=null && isFinite(r.l100));
  const avg_l100 = valid.length? valid.reduce((a,r)=>a+r.l100,0)/valid.length : null;
  const avg_eurkm = valid.length? valid.reduce((a,r)=>a+r.eur_km,0)/valid.length : null;
  const total_co2 = rows.reduce((a,r)=>a+(r.co2||0),0);
  return {rows, avg_l100, avg_eurkm, total_co2};
}

// ---- Envío a Google ----
async function sendToGoogle(batch){
  const payload={apiKey:GAS_API_KEY, entries:batch};
  try{
    const res=await fetch(GAS_ENDPOINT,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(payload),mode:'cors',cache:'no-cache'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    return true;
  }catch{
    await fetch(GAS_ENDPOINT,{method:'POST',body:JSON.stringify(payload),mode:'no-cors'}); // fallback
    return true;
  }
}

async function syncQueue(){
  let queue=readLS(LS_QUEUE,[]);
  if(!queue.length){ setStatus('Sincronizado','ok'); return; }
  setStatus(`Enviando ${queue.length}…`,'warn');
  const batch=queue.slice(0,20);
  try{
    const ok=await sendToGoogle(batch);
    if(ok){
      const keep=new Set(batch.map(x=>x.id));
      queue=readLS(LS_QUEUE,[]).filter(x=>!keep.has(x.id));
      writeLS(LS_QUEUE,queue);
      setStatus(queue.length?`Pendientes ${queue.length}`:'Sincronizado',queue.length?'warn':'ok');
      renderSummary(); if(queue.length) syncQueue();
    }
  }catch{ setStatus('Error de envío','err'); }
}

// ---- Lectura del histórico desde Sheets ----
async function fetchRemote(limit=50){
  try{
    // intento por POST (evita CORS raros)
    const res=await fetch(GAS_ENDPOINT,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify({apiKey:GAS_API_KEY,op:'list',limit}),mode:'cors'});
    const j=await res.json(); if(!j.ok) throw new Error(j.error||'read error'); 
    return Array.isArray(j.entries)? j.entries : [];
  }catch{
    // segundo intento por GET (si tu entorno permite CORS de GAS)
    try{
      const url=`${GAS_ENDPOINT}?op=list&limit=${limit}${GAS_API_KEY?`&key=${encodeURIComponent(GAS_API_KEY)}`:''}`;
      const r=await fetch(url,{mode:'cors'}); const j=await r.json(); return j.entries||[];
    }catch{ return []; }
  }
}

async function renderSummary(){
  // remoto + local pendientes
  const remote = await fetchRemote(50);
  const local  = readLS(LS_ENTRIES, []);
  const all = [...remote, ...local]; // si hay duplicados por id, podríamos deduplicar
  const {rows, avg_l100, avg_eurkm, total_co2} = enrichRows(all);
  document.getElementById('s-consumo').textContent = avg_l100? fmt(avg_l100) : '–';
  document.getElementById('s-coste').textContent   = avg_eurkm? fmt(avg_eurkm,3) : '–';
  document.getElementById('s-co2').textContent     = fmt(total_co2);

  const tbody=document.querySelector('#tabla tbody');
  const last=rows.slice(-8); // últimos 8
  tbody.innerHTML = last.map(r=>`<tr>
    <td>${r.fecha||''}</td>
    <td>${fmt(r.euros,2)}</td>
    <td>${fmt(r.precio_litro,3)}</td>
    <td>${fmt(r.km,0)}</td>
    <td>${fmt(r.litros,2)}</td>
    <td>${r.l100!=null? fmt(r.l100,2):'–'}</td>
  </tr>`).join('');
}

// ---- Form ----
function toDateStr(d){ return new Date(d).toISOString().slice(0,10) }
async function addEntry(ev){
  ev.preventDefault();
  const fd=new FormData(document.getElementById('form'));
  const entry={
    id:uuid(),
    fecha:fd.get('fecha'),
    vehiculo:fd.get('vehiculo')||'Peugeot 206',
    fuel:fd.get('fuel')||'Diésel',
    euros:parseFloat(fd.get('euros')),
    precio_litro:parseFloat(fd.get('precio_litro')),
    km:parseFloat(fd.get('km')),
    estacion:fd.get('estacion')||'',
    pago:fd.get('pago')||'Tarjeta',
    notas:(fd.get('notas')||'').toString().slice(0,500)
  };
  if(!entry.fecha||!isFinite(entry.euros)||!isFinite(entry.precio_litro)||!isFinite(entry.km)){ alert('Revisa los campos obligatorios.'); return; }
  const entries=readLS(LS_ENTRIES,[]); entries.push(entry); writeLS(LS_ENTRIES,entries);
  const queue=readLS(LS_QUEUE,[]); queue.push(entry); writeLS(LS_QUEUE,queue);
  setStatus('Pendiente de envío','warn');
  document.getElementById('form').reset(); document.getElementById('fecha').value=toDateStr(new Date());
  renderSummary(); syncQueue();
}

// ---- init ----
(async function(){
  if('serviceWorker' in navigator){ try{ await navigator.serviceWorker.register('sw.js',{scope:'./'});}catch{} }
  document.getElementById('form').addEventListener('submit', addEntry);
  document.getElementById('btn-clear').addEventListener('click', ()=> document.getElementById('form').reset());
  document.getElementById('fecha').value = toDateStr(new Date());
  window.addEventListener('online', syncQueue);
  window.addEventListener('focus', ()=> setTimeout(syncQueue, 300));
  await renderSummary();
})();
</script>
</body>
</html>
